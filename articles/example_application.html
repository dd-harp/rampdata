<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Example Application • rampdata</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Example Application">
<meta property="og:description" content="rampdata">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">rampdata</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/example_application.html">Example Application</a>
    </li>
    <li>
      <a href="../articles/path_scenario.html">Path Interface</a>
    </li>
    <li>
      <a href="../articles/ramp_example.html">Demonstrate Package</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="example_application_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Example Application</h1>
            
      
      
      <div class="hidden name"><code>example_application.Rmd</code></div>

    </div>

    
    
<div id="introduction" class="section level1">
<h1 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h1>
<p>This notebook shows how to use the <code>rampdata</code> package in an application. This package will add several features to the main function, if we initialize it to use those features.</p>
<ol style="list-style-type: decimal">
<li>Logging that will be saved specially on the cluster.</li>
<li>Provenance of files saved with each file and provenance of the main function saved in the provenance directory beside the data.</li>
<li>All paths specified relative to the data directory that’s configured for each user and machine. This lets you run from the cluster or from home.</li>
<li>Input files and output files can be specified to have a particular version by giving a workflow configuration file.</li>
</ol>
<p>When you read this, please consider first, not the syntax, but whether this would fit with the flow of how you work. We can make the syntax easier and more automatic if it can first ensure it doesn’t preclude how you work.</p>
</div>
<div id="main" class="section level1">
<h1 class="hasAnchor">
<a href="#main" class="anchor"></a>Main</h1>
<div id="the-main-function" class="section level2">
<h2 class="hasAnchor">
<a href="#the-main-function" class="anchor"></a>The main function</h2>
<p>We put code into packages, and one or more functions in that package are top-level functions. A researcher or a workflow tool will call those functions directly. These are main functions, and the <code>rampdata</code> package helps write them so that they run better on the cluster.</p>
<p>A main function can either be called interactively, at an R command line, or from the command line as <code>R -e "function()"</code>, or from the command line as a script. In the last case, you write a script, such as</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">gisdemog</span><span class="fu">::</span><span class="fu">create_uganda_cover</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p>I would save that single line into a file <code>uganda_cover.R</code> and run it from the command line with <code>Rscript uganda_cover.R --shapefile uganda.shp</code>.</p>
</div>
<div id="the-usual-layout-of-a-main-function" class="section level2">
<h2 class="hasAnchor">
<a href="#the-usual-layout-of-a-main-function" class="anchor"></a>The usual layout of a main function</h2>
<p>A main function function usually separates sanity-checking tasks and input/output tasks from the work of the function. We try to write the main function so that it can be called as a script, meaning called from <code>R --no-save -e "package::runit()"</code> or so it can be called as a function from the R prompt. We can write the function and wrap it to be called as a script in these two steps, where the second one processes command-line arguments.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">create_uganda_cover</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">shapefile</span>, <span class="va">landscape</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">inputs</span> <span class="op">&lt;-</span> <span class="fu">read_input_files</span><span class="op">(</span><span class="va">shapefile</span>, <span class="va">landscape</span><span class="op">)</span>
  <span class="va">outputs</span> <span class="op">&lt;-</span> <span class="fu">calculate_uganda_cover</span><span class="op">(</span><span class="va">inputs</span><span class="op">$</span><span class="va">shapefile</span>, <span class="va">inputs</span><span class="op">$</span><span class="va">lanscape</span><span class="op">)</span>
  <span class="fu">write_outputs</span><span class="op">(</span><span class="va">outputs</span><span class="op">$</span><span class="va">cover</span><span class="op">)</span>
<span class="op">}</span>
<span class="va">create_uganda_cover_main</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span><span class="op">(</span><span class="va">create_uganda_cover</span>, <span class="fu">cover_parse_args</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/commandArgs.html">commandArgs</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>The first function is ready to call from the R command line. The second function is ready to call from the Bash command line on the cluster.</p>
</div>
<div id="a-main-function-as-a-script" class="section level2">
<h2 class="hasAnchor">
<a href="#a-main-function-as-a-script" class="anchor"></a>A main function as a script</h2>
<p>Sometimes we write scripts. They aren’t different from main functions in any way that’s important for the rampdata additions.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">args</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span><span class="op">(</span><span class="va">create_uganda_cover</span>, <span class="fu">cover_parse_args</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/commandArgs.html">commandArgs</a></span><span class="op">(</span>trailing <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="va">inputs</span> <span class="op">&lt;-</span> <span class="fu">read_input_files</span><span class="op">(</span><span class="va">args</span><span class="op">$</span><span class="va">shapefile</span>, <span class="va">args</span><span class="op">$</span><span class="va">landscape</span><span class="op">)</span>
<span class="va">outputs</span> <span class="op">&lt;-</span> <span class="fu">calculate_uganda_cover</span><span class="op">(</span><span class="va">inputs</span><span class="op">$</span><span class="va">shapefile</span>, <span class="va">inputs</span><span class="op">$</span><span class="va">lanscape</span><span class="op">)</span>
<span class="fu">write_outputs</span><span class="op">(</span><span class="va">outputs</span><span class="op">$</span><span class="va">cover</span><span class="op">)</span></code></pre></div>
</div>
<div id="an-updated-version-of-the-main-function" class="section level2">
<h2 class="hasAnchor">
<a href="#an-updated-version-of-the-main-function" class="anchor"></a>An updated version of the main function</h2>
<p>Most of the new work in the main function will be done while parsing arguments. The one important piece to add is a <code>tryCatch</code> around the work of the main function. The goal is to clear the slate for provenance and ensure we save it at the end.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a>create_uganda_cover &lt;-<span class="st"> </span><span class="cf">function</span>(shapefile, landscape) {</span>
<span id="cb4-2"><a href="#cb4-2"></a>  rampdata<span class="op">::</span><span class="kw">clear.provenance</span>()</span>
<span id="cb4-3"><a href="#cb4-3"></a>  <span class="kw">tryCatch</span>({</span>
<span id="cb4-4"><a href="#cb4-4"></a>    inputs &lt;-<span class="st"> </span><span class="kw">read_input_files</span>(shapefile, landscape)</span>
<span id="cb4-5"><a href="#cb4-5"></a>    outputs &lt;-<span class="st"> </span><span class="kw">calculate_uganda_cover</span>(inputs<span class="op">$</span>shapefile, inputs<span class="op">$</span>lanscape)</span>
<span id="cb4-6"><a href="#cb4-6"></a>    <span class="kw">write_outputs</span>(outputs<span class="op">$</span>cover)</span>
<span id="cb4-7"><a href="#cb4-7"></a>  }, <span class="dt">finally =</span> {</span>
<span id="cb4-8"><a href="#cb4-8"></a>    rampdata<span class="op">::</span><span class="kw">write.meta.data</span>(</span>
<span id="cb4-9"><a href="#cb4-9"></a>      rampdata<span class="op">::</span><span class="kw">ramp_prov_path</span>(<span class="st">"package"</span>, <span class="st">"create_uganda_cover"</span>))</span>
<span id="cb4-10"><a href="#cb4-10"></a>  }</span>
<span id="cb4-11"><a href="#cb4-11"></a><span class="er">}</span></span>
<span id="cb4-12"><a href="#cb4-12"></a>create_uganda_cover_main &lt;-<span class="st"> </span><span class="cf">function</span>() {</span>
<span id="cb4-13"><a href="#cb4-13"></a>  <span class="kw">do.call</span>(create_uganda_cover, <span class="kw">cover_parse_args</span>(<span class="kw">commandArgs</span>()))</span>
<span id="cb4-14"><a href="#cb4-14"></a>}</span></code></pre></div>
<p>The provenance recording isn’t nested. Clearing it will delete everything this package remembers.</p>
</div>
</div>
<div id="argument-parsing-and-initialization" class="section level1">
<h1 class="hasAnchor">
<a href="#argument-parsing-and-initialization" class="anchor"></a>Argument parsing and initialization</h1>
<p>When we parse arguments to the code, we need to initialize</p>
<ol style="list-style-type: decimal">
<li><p>Logging - Tell it whether we are on the cluster or on a local machine. When on the cluster, warnings, errors, and fatal messages will be saved to a separate file. We can also change the logging level for the whole application or for particular packages or R scripts.</p></li>
<li><p>Workflow versions - This is a file with lists of versions and the file paths they affect.</p></li>
</ol>
<p>The location of the data directory is initialized as needed from a configuration file in the home directory.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">.cover.doc</span> <span class="op">&lt;-</span> <span class="st">'Create Uganda Coverage

Usage:
  create_uganda_coverage &lt;workflow&gt; [-v] [-q] [--local]

Options:
  -v       Set logging to debug level.
  -q       Set logging to warn level.
  --local  Working on a local machine, not the cluster.
'</span>
<span class="va">cover_parse_args</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">args</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span>
  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="va">args</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">args</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/commandArgs.html">commandArgs</a></span><span class="op">(</span><span class="cn">TRUE</span><span class="op">)</span>
  <span class="op">}</span>
  <span class="va">parsed</span> <span class="op">&lt;-</span> <span class="fu">docopt</span><span class="fu">::</span><span class="fu">docopt</span><span class="op">(</span><span class="va">.cover.doc</span>, args <span class="op">=</span> <span class="va">args</span>, version <span class="op">=</span> <span class="st">"1.0"</span><span class="op">)</span>
  
  <span class="va">calling_function</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/deparse.html">deparse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sys.parent.html">sys.call</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sys.parent.html">sys.parent</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
  <span class="fu">set_logging_from_args</span><span class="op">(</span>
    <span class="fu">utils</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/utils/packageName.html">packageName</a></span><span class="op">(</span><span class="op">)</span>, <span class="va">calling_function</span>, <span class="va">parsed</span><span class="op">$</span><span class="va">v</span>, <span class="va">parsed</span><span class="op">$</span><span class="va">q</span>, <span class="va">parsed</span><span class="op">$</span><span class="va">local</span>
    <span class="op">)</span>
  <span class="fu"><a href="../reference/initialize_workflow.html">initialize_workflow</a></span><span class="op">(</span><span class="va">args</span><span class="op">$</span><span class="va">workflow</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
</div>
<div id="file-provenance-along-the-way" class="section level1">
<h1 class="hasAnchor">
<a href="#file-provenance-along-the-way" class="anchor"></a>File provenance along the way</h1>
<p>Each time we read or write a file, we record its provenance. There is an incantation when we read. We can shorten these lines of code if we determine they do what we want.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">pop_rp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/workflow_path.html">workflow_path</a></span><span class="op">(</span><span class="st">"admin1pop"</span><span class="op">)</span>
<span class="va">file_rp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/add_path.html">add_path</a></span><span class="op">(</span><span class="va">pop_rp</span>, file <span class="op">=</span> <span class="st">"pop2000.csv"</span><span class="op">)</span>
<span class="va">dt</span> <span class="op">&lt;-</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/fread.html">fread</a></span><span class="op">(</span><span class="fu"><a href="../reference/as.path.html">as.path</a></span><span class="op">(</span><span class="va">file_rp</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="../reference/prov.input.file.html">prov.input.file</a></span><span class="op">(</span><span class="fu"><a href="../reference/as.path.html">as.path</a></span><span class="op">(</span><span class="va">file_rp</span><span class="op">)</span>, <span class="st">"admin1pop"</span><span class="op">)</span></code></pre></div>
<p>When we write, we add a step to save the current provenance of how the file was made. If we write a file called <code>output.csv</code>, then we should write its provenance beside it as <code>output.toml</code>.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">pop_rp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/workflow_path.html">workflow_path</a></span><span class="op">(</span><span class="st">"admin1pop"</span><span class="op">)</span>
<span class="va">file_rp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/add_path.html">add_path</a></span><span class="op">(</span><span class="va">pop_rp</span>, file <span class="op">=</span> <span class="st">"pop2000.csv"</span><span class="op">)</span>
<span class="va">dt</span> <span class="op">&lt;-</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/fwrite.html">fwrite</a></span><span class="op">(</span><span class="fu"><a href="../reference/as.path.html">as.path</a></span><span class="op">(</span><span class="va">file_rp</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="../reference/prov.output.file.html">prov.output.file</a></span><span class="op">(</span><span class="fu"><a href="../reference/as.path.html">as.path</a></span><span class="op">(</span><span class="va">file_rp</span><span class="op">)</span>, <span class="st">"admin1pop"</span><span class="op">)</span>
<span class="fu"><a href="../reference/write.meta.data.html">write.meta.data</a></span><span class="op">(</span>
      <span class="fu"><a href="../reference/as.path.html">as.path</a></span><span class="op">(</span><span class="fu"><a href="../reference/add_path.html">add_path</a></span><span class="op">(</span><span class="va">file_rp</span>, file <span class="op">=</span> <span class="st">"pop2000.toml"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Drew Dolgert.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
